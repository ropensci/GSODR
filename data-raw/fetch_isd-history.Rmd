---
title: "Fetch and Clean 'isd_history.csv' File"
author: "Adam H. Sparks"
date: "`r Sys.Date()`"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r color, echo = FALSE, results='asis'}
# crayon needs to be explicitly activated in Rmd
options(crayon.enabled = TRUE)
# Hooks needs to be set to deal with outputs
# thanks to fansi logic
old_hooks <- fansi::set_knit_hooks(knitr::knit_hooks, 
                                   which = c("output", "message", "error"))
```

# Introduction

The "isd_history.csv" file details GSOD station metadata.
These data include the start and stop years used by {GSODR} to pre-check requests before querying the server for download and the country code used by {GSODR} when sub-setting for requests by country.
The following checks are performed on the raw data file before inclusion in {GSODR},

-   Check for valid lon and lat values;

    -   isd_history where latitude or longitude are `NA` or both 0 are removed leaving only properly georeferenced stations,

    -   isd_history where latitude is < -90˚ or > 90˚ are removed,

    -   isd_history where longitude is < -180˚ or > 180˚ are removed.

-   A new field, STNID, a concatenation of the USAF and WBAN fields, is added.

# Data Processing

## Set up workspace

```{r load_libs, echo=TRUE, message=FALSE, output=FALSE, warning=FALSE}
library("sessioninfo")
library("countrycode")
library("data.table")
library("sf")
library("dplyr")
library("geodata")
library("diffobj")

new_isd_history <- fread("https://www.ncei.noaa.gov/pub/data/noaa/isd-history.csv")
```


## Add country names based on geographic location

Previously (prior to 2025-11-04) I used the FIPS code in the CSV file to determine the country.
This turned out to be [problematic](https://github.com/ropensci/GSODR/issues/133#issuecomment-3483206035).
So, I've gone to a brute-force method of determining which country the lat/lon values fall in using {rnaturalearth} and {sf}.

```{r merge-country, eval=TRUE, message=FALSE}
# isd_history
# pad WBAN where necessary
new_isd_history[, WBAN := sprintf("%05d", WBAN)]

# add STNID column
new_isd_history[, STNID := paste(USAF, WBAN, sep = "-")]
setcolorder(new_isd_history, "STNID")

# clean data
new_isd_history[new_isd_history == -999] <- NA
new_isd_history[new_isd_history == -999.9] <- NA
new_isd_history <-
  new_isd_history[!is.na(new_isd_history$LAT) &
                    !is.na(new_isd_history$LON),]
new_isd_history <-
  new_isd_history[new_isd_history$LAT != 0 &
                    new_isd_history$LON != 0,]
new_isd_history <-
  new_isd_history[new_isd_history$LAT > -90 &
                    new_isd_history$LAT < 90,]
new_isd_history <-
  new_isd_history[new_isd_history$LON > -180 &
                    new_isd_history$LON < 180,]

sf_use_s2(FALSE)

coords_sf <- 
  st_as_sf(
  new_isd_history,
  coords = c("LON", "LAT"),
  crs = 4326,
  remove = FALSE
 ) |> select(STNID, `STATION NAME`, STATE, `ELEV(M)`, BEGIN, END, LON, LAT)

world <- st_as_sf(world(resolution = 1L)) |>
  st_transform(crs = 4326)

within_dt <- st_join(
  x = coords_sf,
  y = world,
  join = st_within) |>
  as.data.table()

new_isd_history <-
  within_dt[as.data.table(codelist), on = c("NAME_0" = "country.name.en")]

# remove rows with no stations
new_isd_history <- new_isd_history[complete.cases(new_isd_history$STNID), ]

new_isd_history <- new_isd_history[, c(
  "STNID",
  "STATION NAME",
  "LAT",
  "LON",
  "ELEV(M)",
  "STATE",
  "BEGIN",
  "END",
  "NAME_0",
  "fips",
  "iso2c",
  "iso3c"
)]

setnames(
  new_isd_history,
  c(
    "STATION NAME",
    "NAME_0",
    "fips",
    "iso2c",
    "iso3c"
  ),
  c(
    "NAME",
    "COUNTRY_NAME",
    "CTRY",
    "ISO2C",
    "ISO3C"
  )
)
setcolorder(
  new_isd_history,
    c(
      "STNID",
      "NAME",
      "LAT",
      "LON",
      "ELEV(M)",
      "STATE",
      "BEGIN",
      "END",
      "COUNTRY_NAME",
      "ISO2C",
      "ISO3C",
      "CTRY"
))

# set key for joins when processing CSV files
setkeyv(new_isd_history, "STNID")
```

## Show changes from last release

```{r diff-codes}
# ensure we aren't using a locally installed dev version
install.packages("GSODR", repos = "https://cloud.r-project.org/")
load(system.file("extdata", "isd_history.rda", package = "GSODR"))

# select only the cols of interest
x <- names(isd_history)
new_isd_history <- new_isd_history[, ..x] 
cat(                                 # output to screen
  as.character(                      # convert to diff to character vector
    diffPrint(new_isd_history, isd_history, format = "raw", strip.sgr = FALSE)
    )
  )
```

## View and save the data

```{r view-and-save}
rm(isd_history)
isd_history <- new_isd_history

str(isd_history)

# write rda file to disk for use with GSODR package
save(isd_history,
     file = "../inst/extdata/isd_history.rda",
     compress = "bzip2")

save(isd_diff,
     file = "../inst/extdata/isd_diff.rda",
     compress = "bzip2")
```

# Notes

## NOAA policy

Users of these data should take into account the following (from the [NCEI website](https://www.ncei.noaa.gov/access/metadata/landing-page/bin/iso?id=gov.noaa.ncdc:C00516)):

> The following data and products may have conditions placed on their international commercial use. They can be used within the U.S. or for non-commercial international activities without restriction. The non-U.S. data cannot be redistributed for commercial purposes. Re-distribution of these data by others must provide this same notification. A log of IP addresses accessing these data and products will be maintained and may be made available to data providers.  
> For details, please consult: [WMO Resolution 40. NOAA Policy](https://community.wmo.int/resolution-40)

## R System Information

```{r system_information, echo=FALSE}
session_info()
```
